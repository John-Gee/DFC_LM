#!/usr/bin/env bash


function addCSUM() {
    extension="$1"

    grep -o -P -e "\".*\.$extension.*?\"" index.html | while read -r line
    do
        if [[ $line == *"http"* ]]
        then
            continue
        fi

        line=${line:1:-1}
        cleanLine="${line%\?*}"
        xxcsum=`xxh32sum "$cleanLine"`
        csum="${xxcsum:0:8}"
        sed -i "s|\"$line\"|\"$cleanLine?c=$csum\"|" index.html
    done
}

function cleanPaths() {
    sed -i "s|../docs/||" "$1"
}

function minify() {
    minCSS=`cat css/{chart,fonts,guide,select2,style,queries}.css |
    sed "s|../docs/||" | sed "s|../fonts/|fonts/|" |npx postcss -m`
    for f in {chart,fonts,guide,select2,queries}.css
    do
        sed -i "/^.*$f.*$/d" ../docs/index.html
    done
    sed -i "s|^.*style.css.*$|<style type=text/css>$minCSS</style>|" ../docs/index.html

    for f in {events,functions}
    do
        cp js/"$f"{.js,2.js}
        cleanPaths js/$f.js
    done
    uglifyjs js/{events,functions}.js -o ../docs/js/functions.min.js \
    -c -m --source-map "root='../src/js',url='functions.min.js.map'"
    sed -i "s|functions.js|functions.min.js|" ../docs/index.html
    for f in events
    do
        sed -i "/^.*$f\.js.*$/d" ../docs/index.html
        mv js/"$f"2.js js/"$f".js
    done
    mv js/functions2.js js/functions.js

    cleanPaths ../docs/index.html
    npx html-minifier --collapse-boolean-attributes --collapse-inline-tag-whitespace \
    --collapse-whitespace --conservative-collapse --decode-entities --minify-urls \
    --no-include-auto-generated-tags --prevent-attributes-escaping \
    --process-conditional-comments --quote-character "'" --remove-attribute-quotes \
    --remove-comments --remove-empty-attributes --remove-optional-tags \
    --remove-redundant-attributes --sort-attributes --sort-class-name \
    --trim-custom-fragments --use-short-doctype ../docs/index.html  -o ../docs/index.html
}

cp -a index.html ../docs/
minify
cd ../docs/
addCSUM js
addCSUM css
